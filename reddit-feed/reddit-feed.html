<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/av-icons.html">

<!--
`reddit-feed`
Polymer component to show your favourite subreddits feed

@demo demo/index.html 
-->

<dom-module id="reddit-feed">
  <template>

    <iron-ajax
       id="refresh_token" 
       url="https://www.reddit.com/api/v1/access_token" 
       method="POST"
       headers="{{_token_headers}}" 
       params="{{_token_params}}" 
       handle-as='json' 
       on-response="_token_received"
       >
    </iron-ajax>

    <iron-ajax
       id="get_hot" 
       url="https://oauth.reddit.com/r/{{subreddit}}/hot"
       method="GET" 
       headers="{{_api_headers}}" 
       params="{{_hot_params}}" 
       handle-as='json' 
       on-response="_hot_received"
       on-error="_hot_error_received"
       >
    </iron-ajax>

    <style>
      :host {
        display: block;
        background: #EEE;
        display: relative;
        --title-color: #24a0ed;
      }

      .header{
        background-color: var(--paper-blue-200);
      }

      .post{
        margin-left: auto;
        margin-right: auto;
        background-color: white;
        border: 1px solid;
        border-color: var(--paper-grey-400);
        border-radius: 2px;
        display: block;
        width: 90%;
        position: relative;
        margin-bottom: 5px;
        min-height: 78px;
      }

      .preview{
        max-height: 68px;
        min-height: 68px;
        max-width: 62px;
        min-width: 62px;
        float: left;
        margin: 5px;
        position: absolute;
      }

      .play{
        position: absolute;
        z-index: 1;
        left: 43px;
        top: 49px;
        background: none;
        fill: var(--paper-grey-400);
      }

      .postContent{
        position: relative;
        padding: 5px;
        left: 67px;
        width: calc(100% - 67px - 10px);
      }
      .postContent .title{
        font-size: 13.5pt;
        font-family: arial, sans-serif;
        color: var(--title-color);
      }

    </style>
    <!-- HEADER -->
    <div class="header">
      <label for="subreddit">Subreddit</label>
      <input is="iron-input" bind-value="{{subreddit}}" value="Overwatch" name="subreddit" type="text"></input>
      <paper-button raised on-tap="hot">
      HOT
      </paper-button>
      <paper-button raised on-tap="_refresh_token">
      Refresh token
      </paper-button>
      <p>Token: {{token}}</p>
      <p>Refresh: {{refresh_token}}</p>
    </div>    
    <!-- MAIN CONTENT -->
    <template id="feed_template" is="dom-repeat" items="{{feed}}">
      <div class="post">
        <template is="dom-if" if="{{hasMedia(item)}}">
          <a href="{{item.media}}">
            <img class="preview" src="{{item.data.thumbnail}}">
            <iron-icon class="play" icon="av:play-circle-outline"> 
            </iron-icon>
          </a>
        </template>
        <template is="dom-if" if="{{!hasMedia(item)}}">
          <template is="dom-if" if="{{hasPreview(item)}}">
            <img class="preview" src="{{item.image}}">
          </template>
          <template is="dom-if" if="{{!hasPreview(item)}}">
            <iron-icon class="preview" src="{{item.icon}}"></iron-icon>
          </template>
        </template>
        <div class="postContent">
          <div class="title"> 
            {{item.data.title}}
          </div>
          <br> 
          Score: {{item.data.score}}
          <br>
          Comments: {{item.data.num_comments}}
        </div>  
      </div>      
    </template>

  </template>

  <script>
    Polymer({

      is: 'reddit-feed',

      properties: {

        /* Component parameters */

        token: String,

        refresh_token: String,

        client_id: String,

        client_secret: String,

        /* Configuration */

        POSTS_LIMIT: {
          type: Number,
          value: 15
        },

        subreddit: String,

        _api_headers:{
          type: String,
          computed: "_get_api_headers(token)"
        }, 

        _token_headers:{
          type: String,
          computed: "_get_token_headers(client_id, client_secret)"
        },

        _hot_params:{
          type: Object,
          computed: "_get_hot_params(POSTS_LIMIT)"
        },

        _token_params:{
          type: String,
          computed: "_get_token_params(refresh_token)"
        },



      },

      _get_api_headers: function(token){
        return {Authorization: 'Bearer '+token};
      },

      _get_token_headers: function(client_id, client_secret){
        return {Authorization: "Basic " + btoa(client_id + ":" + client_secret)};
      },

      _get_hot_params: function(POSTS_LIMIT){
        return {limit: POSTS_LIMIT};
      },

      _get_token_params: function(refresh_token){
        return {grant_type: "refresh_token", refresh_token: refresh_token};
      },

      _token_received: function(event, detail){
        this.token = detail.response.access_token;
        if(this.recall){
          this.$.get_hot.generateRequest();
          this.recall=false;
        }
      },

      _hot_received: function(event, detail){
        this.feed = detail.response.data.children;
      },

      _hot_error_received: function(event, detail){
        if(detail.request.xhr.status==401){
          this.recall=true;
          this._refresh_token();
        }
      },

      _refresh_token: function(){
        this.$.refresh_token.generateRequest();
      },

      hot: function(){
        this.feed = null;
        this.$.feed_template.render();
        this.$.get_hot.generateRequest();
      },

      hasMedia: function(item){
        var has = false
        if(item.data.media!=null){
          item.media=item.data.url;
          has=true;
        }
        return has;
      },

      hasPreview: function(item){
        var has = false
        if(item.data.preview){
          if(item.data.preview.images[0].variants.gif){
            item.image=item.data.preview.images[0].variants.gif.source.url;
          }
          else{
            item.image=item.data.preview.images[0].source.url;
          }          
          has=true;
        }
        return has;
      },

    });
  </script>
</dom-module>
