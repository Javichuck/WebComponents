<!--
@license
@author Javier Caballero Abenza. All rights reserved.

An element to search and watch videos from YouTube

Example:

    <youtube-wc></youtube-wc>

@element youtube-wc
@demo demo/index.html
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../google-youtube/google-youtube.html">

<dom-module id="youtube-wc">

  <template>
    <style is="custom-style">

      :host {
        display: block;
        min-width: 450px;
        min-height: 350px;        
        width: 450px;
        height: 350px;
        background: var(--paper-grey-300);
        overflow: hidden;
        position: relative;
        
      }

      .header, paper-header-panel{
        min-height: 60px;
        max-height: 60px;
        background: #ffffff;
        color: var(--paper-grey-500);
      }

      .icon{
        padding: 5px;
        --iron-icon-width: 70px;
        --iron-icon-height: 30px;
      }

      paper-icon-button:hover{
        color: var(--paper-grey-900);
      }

      .header ::shadow #topBar {
        padding-left: 0;
      }

      .header .menu{
        margin-left: 5px;
        margin-right: 0;
        padding-left: 0;
        padding-right: 0;
      }

      .header .search-box{
        position: absolute;
        left: 125px;
        top: 0;
        height: 60px;
        width: calc(100% - 125px);
        text-align: center;
      }

      .search-box input{
        width: 60%;
      }

      .search-box input{
        margin-top: 19.5px;
        margin-bottom: 19.5px;
      }

      .search-box paper-icon-button{
        margin-top: 10px;
        margin-bottom: 10px;
      }

      .back{
        position: absolute;
        right: 10px;
      }

      .dropdown-content{
        background: #ffffff;
        width: 100px;
        max-width: 100px;
        color: var(--paper-grey-800);
        padding: 0;

        position: absolute;
        z-index: 1;
        left: -105px;
        top: 60px;
        transition: .5s ease;
      }

      .dropdown-content .item{
        width: 100%;
        margin: 0;
        text-transform: none;
      }

      .content{
        overflow-y: scroll;
        max-height: calc( 100% - 85px);
        width: 100%;
        height: calc( 100% - 85px);
        position: relative;
        padding-top: 25px;
        color: var(--paper-grey-800);
      }

      .resul-item{
        background: #ffffff;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 10px;
        width: 90%;
        min-height: 100px;
        position: relative;
        cursor: pointer;
      }

      .thumbnail{
        position: absolute;
        top: 0;
        left: 0;
        width: 129px;
        height: 100px;
      }

      .info{
        position: relative;
        padding-left: calc(129px + 5px);
        padding-top: 2px;
        padding-bottom: 2px;
        padding-right: 5px;
        word-wrap: break-word;
      }

      .result-title{
        color: #167ac6;
        font: 15px Roboto,arial,sans-serif;
        font-weight: 500;
      }

      .info .result-channel, .result-description{
        font: 12px Roboto,arial,sans-serif;
      }

      .footer{
        position: absolute;
        z-index: 2;
        right: 40%;
        top: 50px;
        max-height: 25px;
        color: var(--paper-grey-800);
        background: transparent;
        text-align: center;
      }

      .footer paper-icon-button{
        z-index: 2;
        padding-top: 1px;
        padding-bottom: 1px;
        max-height: 25px;
      }

      .before{
        padding-left: 10px;
        padding-right: 2px;
      }

      .next{
        padding-left: 2px;
        padding-right: 10px;
      }

      .cursor{
        position: relative;
        z-index: 2;
      }

      .triangleRight{
        z-index: 1;
        position: absolute;
        top: 0;
        right: -2px;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 25px 25px 0 0;
        border-color: #ffffff transparent transparent transparent;
      }

      .square{
        z-index: 1;
        position: absolute;
        top: 0;
        left: 23px;
        width: 50px;
        height: 0;
        border-style: solid;
        border-width: 0 0 25px 0;
        border-color: #ffffff; 
      }

      .triangleLeft{
        z-index: 1;
        position: absolute;
        top: 0;
        left: -2px;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 25px 25px 0;
        border-color: transparent #ffffff transparent transparent;
      }

      .content2{
        max-height: calc( 100% - 60px);
        padding-top: 0px;
        color: var(--paper-grey-800);
      }

      .video{
        background: #000000;
      }

      .video ::shadow #container{
        max-width: 90%;
        margin-left: auto;
        margin-right: auto;
      }

      .video-stats, .comments{
        max-width: 90%;
        margin-left: auto;
        margin-right: auto;
        background: #ffffff;
        color: var(--paper-grey-900);
        padding: 10px;
      }

      .channel-stats{
        position: relative;
        margin-top: 10px;
        min-height: 60px;
        padding-left: 70px;
        max-width: calc(100% - 70px);
      }

      .detail-title{        
        font: 24px Roboto,arial,sans-serif;
      }

      .detail-channel{
      }

      .channel-img{
        position: absolute;
        top: 0;
        left: 0;
        width: 60px;
        height: 60px;
      }

      .comments{
        margin-top: 10px;
      }

      .comment{
        position: relative;
        margin-bottom: 20px;
        min-height: 50px;
      }

      .comment-img{
        position: absolute;
        margin-top: 2px;
        top: 0;
        left: 0;
        width: 50px;
        height: 50px;
      }

      .comment-name, .comment-text{
        padding-left: 60px;
        max-width: calc(100% - 70px);
        font: 15px Roboto,arial,sans-serif;
      }

      .comment-name{
        color: #167ac6;
        font-weight: 500;
      }

      .comment-area{
        max-width: calc(100% - 7px);
      }
  
    </style>
    <!--
    <input is="iron-input" bind-value="{{_keywords}}">
    <paper-button raised on-click="search">SEARCH</paper-button>
    -->
    <!-- HEADER -->
    <paper-header-panel mode="seamed">
      <paper-toolbar class="header">
        <paper-icon-button icon="menu" class="menu" on-click="_toggle"></paper-icon-button>
        <iron-icon src="resources/youtube.png" class="icon"></iron-icon>
        <div class="search-box">
          <input value="{{_keywords::input}}" on-keydown="_check_search">
          <paper-icon-button icon="search" on-click="search"></paper-icon-button>
          <paper-icon-button class="back" icon="icons:undo" on-click="_back" hidden="{{!_view_detail}}"></paper-icon-button>
        </div>
      </paper-toolbar>
    </paper-header-panel>
    <paper-menu id="dropdown-content" class="dropdown-content" role="listbox">
      <paper-button raised class="item">Opcion 1</paper-button>
      <paper-button raised class="item">Opcion 2</paper-button>
      <paper-button raised class="item">Opcion 3</paper-button>
    </paper-menu>
    <!-- MAIN CONTENT -->
    <div class="content" hidden="{{_view_detail}}">
      <template id="results_template" is="dom-repeat" items="[[result.items]]">
        <div class="resul-item" on-click="detail">
          <img class="thumbnail" src="{{item.snippet.thumbnails.default.url}}">
          <div class="info">
            <div class="result-title">{{item.snippet.title}}</div>
            <div class="result-channel">{{item.snippet.channelTitle}}</div>
            <div class="result-channel">{{_getDate(item)}}</div>
            <div class="result-description">{{item.snippet.description}}</div>
          </div>
        </div>
      </template>
      
    </div>
  <div class="content content2" hidden="{{!_view_detail}}">
    <template id="detail" is="dom-if" if="_view_detail">   

      <google-youtube class="video"
        video-id="{{item.id.videoId}}">
      </google-youtube>

      <div class="video-stats">
        <div class="detail-title">{{item.snippet.title}}</div>
        <div class="channel-stats">
          <img class="channel-img" src="{{channel.snippet.thumbnails.default.url}}">
          <div class="detail-channel">{{item.snippet.channelTitle}}</div>   
        </div>
      </div>

      <div class="comments">
        {{words.comments}}
        <textarea class="comment-area" rows="4" cols="50" value="{{commentText::input}}" on-keydown="_check_comment">
        </textarea>
        <hr>
        <template is="dom-repeat" items="[[comments]]">
          <div class="comment">
            <img class="comment-img" src="{{item.snippet.topLevelComment.snippet.authorProfileImageUrl}}">
            <div class="comment-name">{{item.snippet.topLevelComment.snippet.authorDisplayName}}</div>
            <div class="comment-text">{{item.snippet.topLevelComment.snippet.textDisplay}}</div>
          </div>
        </template>
      </div>  

    </template>
  </div>
  <div id="footer" class="footer" hidden="true">
    <a class="triangleLeft"></a>
    <a id="square" class="square"></a>
    <a class="triangleRight"></a>
    <paper-icon-button class="before" icon="icons:arrow-back" on-click="_before"></paper-icon-button>
    <span class="cursor">{{_cursor}}</span>
    <paper-icon-button class="next" icon="icons:arrow-forward" on-click="_next"></paper-icon-button>
    
  </div>


    <!-- AJAX CALLS -->

    <iron-ajax
      id="language_request"
      url="{{component_base}}language/{{_lan_file}}"
      on-response="_language_response"
      >
    </iron-ajax>

    <iron-ajax
       id="refresh_token" 
       url="https://accounts.google.com/o/oauth2/token" 
       method="POST"
       params="{{_token_params}}" 
       on-response="_token_received"
       >
    </iron-ajax>

    <iron-ajax
       id="search_request" 
       url="{{_base_URL}}/search?{{_search_params}}" 
       on-response="_search_response"
       >
    </iron-ajax>

    <iron-ajax
       id="channel_request" 
       url="{{_base_URL}}/channels?part=snippet&key={{api_key}}&id={{item.snippet.channelId}}" 
       on-response="_channel_response"
       >
    </iron-ajax>

    <iron-ajax
      id="comments_request"
      url="{{_base_URL}}/commentThreads?part=snippet&order=relevance&maxResults=10&videoId={{item.id.videoId}}&key={{api_key}}"
      on-response="_comments_response"
      >
    </iron-ajax>

    <iron-ajax
      id="cache_image"
      url="{{image_url}}"
      >
    </iron-ajax>

    <iron-ajax
      id="post_comment"
      method="POST"
      url="{{_base_URL}}/commentThreads?part=id"
      headers="{{_api_headers}}"
      params="{{_post_params}}"
      >
    <iron-ajax>

  </template>

  <script>

    Polymer({

      is: 'youtube-wc',

      properties: {

      //PUBLIC CONFIG PARAMS

        /* Token: The access_token generated to grant access to the API */
        token: {
          type: String,
          reflectToAttribute: true
        },

        /* Refresh Token: The refresh token generated to update the access_token */
        refresh_token: String,

        /* API Key: The API Key for your application */
        api_key: String,

        /* Client Id: The OAuth 2.0 client ID for your application */
        client_id: String,

        /* Client Secret: The OAuth 2.0 client SECRET for your application */
        client_secret: String,

        /* Component Base: The component base directory */
        component_base: {
          type: String,
          value:""
        },

        /* Language: Language for your application */
        language: {
          type: String,
          value: "en",
          observer: "_languageChanged"
        },

      //INTERNAL CONFIG PARAMS

        /* Token refresh */

        _token_params: {
          type: String,
          computed: "_get_token_params(client_id, client_secret, refresh_token)"
        },

        /* API methods */

        _api_headers: {
          type: String,
          computed: "_get_api_headers(token)"
        },

        _post_params: {
          type: String,
          computed: "_get_post_params(channelId, videoId, commentText)"
        },

        _base_URL: {
          type: String,
          value: "https://www.googleapis.com/youtube/v3"
        },

        _maxResults: {
          type: Number,
          value: 10
        },

        /* Pagination */

        _cursor: {
          type: Number,
          value: 0,
        },

        _cache: {
          type: Object,
          value: [],
        },

        /* View */

        _view_detail: {
          type: Boolean,
          value: false
        },


      },

      // LANGUAGE SUPPORT

      _languageChanged: function(newVal, oldValue) {
        switch(newVal){
          case "es":
            this.language = "es";
            this._lan_file = "es_es.json"
            break;
          default:
            this.language = "en";
            this._lan_file = "en_en.json"
        }
        if (this.component_base || this.component_base == "") {
          this.$.language_request.generateRequest();
        }
      },

      _language_response: function(event, detail){
        this.words = detail.response;
      },

      // TOKEN REFRESH

      _get_token_params: function(client_id, client_secret, refresh_token){
        return {
            client_id: client_id, 
            client_secret: client_secret, 
            refresh_token: refresh_token, 
            grant_type: "refresh_token"
          };
      },

      _token_received: function(event, detail){
        this.token = detail.response.access_token;
      },

      // API METHODS

      _get_api_headers: function(token){
        return {Authorization: 'Bearer '+token};
      },

      _get_post_params: function(channelId, videoId, commentText){
        return {
          "snippet.channelId": channelId,
          "snippet.videoId": videoId,
          "snippet.topLevelComment.snippet.textOriginal": commentText
        }
      }, 

      _search_response: function(event, detail){
        this.result = detail.response;
      },

      _channel_response: function(event, detail){
        this.channel = detail.response.items[0];
        this._view_detail = true;
      },

      _comments_response: function(event, detail){
        this.comments = detail.response.items;
        for(var i=0; i<this.comments.length; i++){
          this.image_url = this.comments[i].snippet.topLevelComment.snippet.authorProfileImageUrl;
          this.$.cache_image.generateRequest();
        }
      },

      // PUBLIC METHODS

      search: function(){
        //Clear window and params
        this._view_detail = false;
        if(this.$.footer.hidden)this.$.footer.hidden = false;
        this._cache = [];
        this._cursor = 0;
        this.$['square'].style.width="50px";
        //Generate request
        this._search_params =
        'part=snippet&'+
        'key=' + this.api_key + '&' +
        'q=' + this._keywords + '&' +
        'maxResults=' + this._maxResults;
        
        this._last_search = this._keywords;
        this.$.search_request.generateRequest();
      },

      _search_next: function(){
        if(this._last_search && this._cache[this._cursor].nextPageToken){
          this._search_params =
          'part=snippet&'+
          'key=' + this.api_key + '&' +
          'q=' + this._last_search + '&' +
          'maxResults=' + this._maxResults + '&' +
          'pageToken=' + this._cache[this._cursor].nextPageToken;
          
          this.$.search_request.generateRequest();
        }
      },

      comment: function(){
        this.channelId = this.channel.id;
        this.videoId = this.item.id.videoId;
        this.$.post_comment.generateRequest();
      },

      // ELEMENT BEHAVIOUR

      /* Pagination */

      _clear: function(){
        this.result = null;
        this.$.results_template.render();
      },

      _next: function(){
        if(this._cache[this._cursor+1]){
          this._clear();
          this.result = this._cache[this._cursor+1];
        }
        else{
          this._cache[this._cursor] = this.result;
          this._clear();
          this._search_next();
        }        
        this._cursor++;
        if(this._cursor > 9){
          this.$['square'].style.width="59px";
        }
      },

      _before: function(){
        if(this._cursor > 0){
          if(!this._cache[this._cursor]){
            this._cache[this._cursor] = this.result;
          }          
          this._cursor--;
          if(this._cursor == 9){
            this.$['square'].style.width="50px";
          }
          this._clear();
          this.result = this._cache[this._cursor];

        }

      },

      /* Side Menu animation */
      _toggle: function(){
        if(this.$['dropdown-content'].style.left=="-105px"){
          this.$['dropdown-content'].style.left="0";
        }
        else{
          this.$['dropdown-content'].style.left="-105px";
        }
      },

      /* Allow search typing ENTER */
      _check_search: function(e){
        if(e.keyCode === 13){
          this.search();
        }
      },

      /* Allow comment typing ENTER */
      _check_comment: function(e){
        if(e.keyCode === 13){
          this.comment();
        }
      },

      /* Detail view */
      detail: function(e){
        this.item = e.model.item;
        this.$.channel_request.generateRequest();
        this.$.comments_request.generateRequest();
        this.$.footer.hidden = true;
      },

      /* Results view */
      _back: function(){
        this._view_detail = false;
        this.$.footer.hidden = false;
        this.item = {};
      },

      _getDate: function(item){
        var d = new Date(item.snippet.publishedAt);
        var diff = new Date() - d;
        diff = Math.floor(diff/(1000*60*60*24));
        var out = "";
        if(diff == 0)out = this.words.today;
        else{
          if(diff == 1)out = 1 +' '+ this.words.day;
          else if(30 > diff && diff > 1)out = diff +' '+ this.words.days;
          else if(60 > diff && diff >= 30)out = Math.floor(diff/30) +' '+ this.words.month;
          else if(365 > diff && diff >= 60)out = Math.floor(diff/30) +' '+ this.words.months;
          else if(730 > diff && diff >= 365)out = Math.floor(diff/365) +' '+ this.words.year;
          else if(diff >= 730)out = Math.floor(diff/365) +' '+ this.words.years;
          out = this.words.published + out + this.words.ago;
        }
        return out;
      },

      // Element Lifecycle

      ready: function() {
        // `ready` is called after all elements have been configured, but
        // propagates bottom-up. This element's children are ready, but parents
        // are not.
        //
        // This is the point where you should make modifications to the DOM (when
        // necessary), or kick off any processes the element wants to perform.
      },

      attached: function() {
        // `attached` fires once the element and its parents have been inserted
        // into a document.
        //
        // This is a good place to perform any work related to your element's
        // visual state or active behavior (measuring sizes, beginning animations,
        // loading resources, etc).
        this.$['dropdown-content'].style.left="-105px";
      },

      detached: function() {
        // The analog to `attached`, `detached` fires when the element has been
        // removed from a document.
        //
        // Use this to clean up anything you did in `attached`.
      },

    });


  </script>

</dom-module>