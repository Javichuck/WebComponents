<!--
@license
@author Javier Caballero Abenza. All rights reserved.

An element to search and watch videos from YouTube

Example:

    <youtube-wc></youtube-wc>

@element youtube-wc
@demo demo/index.html
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">

<dom-module id="youtube-wc">

  <template>
    <style is="custom-style">

      :host {
        display: block;
        min-width: 450px;
        min-height: 300px;        
        width: 600px;
        height: 400px;
        background: var(--paper-grey-300);
        overflow: hidden;
        position: relative;
        
      }

      .header, paper-header-panel{
        min-height: 60px;
        max-height: 60px;
        background: #ffffff;
        color: var(--paper-grey-500);
      }

      .icon{
        padding: 5px;
        --iron-icon-width: 70px;
        --iron-icon-height: 30px;
      }

      paper-icon-button:hover{
        color: var(--paper-grey-900);
      }

      .header ::shadow #topBar {
        padding-left: 0;
      }

      .header .menu{
        margin-left: 5px;
        margin-right: 0;
        padding-left: 0;
        padding-right: 0;
      }

      .header .search-box{
        position: absolute;
        left: 125px;
        top: 0;
        height: 60px;
        width: calc(100% - 125px);
        text-align: center;
      }

      .search-box input{
        width: 60%;
      }

      .search-box input{
        margin-top: 19.5px;
        margin-bottom: 19.5px;
      }

      .search-box paper-icon-button{
        margin-top: 10px;
        margin-bottom: 10px;
      }

      .dropdown-content{
        background: #ffffff;
        width: 100px;
        max-width: 100px;
        color: var(--paper-grey-800);
        padding: 0;

        position: absolute;
        z-index: 1;
        left: -105px;
        top: 60px;
        transition: .5s ease;
      }

      .dropdown-content .item{
        width: 100%;
        margin: 0;
        text-transform: none;
      }

      .content{
        overflow-y: scroll;
        max-height: calc( 100% - 95px);
        width: 100%;
        position: relative;
        margin-top: 10px;
        color: var(--paper-grey-800);
      }

      .resul-item{
        background: #ffffff;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 10px;
        width: 90%;
        min-height: 100px;
        position: relative;
      }

      .thumbnail{
        position: absolute;
        top: 0;
        left: 0;
        width: 129px;
        height: 100px;
      }

      .info{
        position: relative;
        padding-left: calc(129px + 5px);
        padding-top: 2px;
        padding-bottom: 2px;
        padding-right: 5px;
        word-wrap: break-word;
      }

      .info .result-title{
        color: #167ac6;
        font: 15px Roboto,arial,sans-serif;
        font-weight: 500;
      }

      .info .result-channel, .result-description{
        font: 12px Roboto,arial,sans-serif;
      }

      .footer{
        position: absolute;
        bottom: 0;
        width: 100%;
        max-height: 25px;
        color: var(--paper-grey-900);
        background: #ffffff;
        text-align: center;
      }

      .footer paper-icon-button{
        padding-top: 1px;
        padding-bottom: 1px;
        max-height: 25px;
      }
  
    </style>
    <!--
    <input is="iron-input" bind-value="{{_keywords}}">
    <paper-button raised on-click="search">SEARCH</paper-button>
    -->
    <!-- HEADER -->
    <paper-header-panel mode="seamed">
      <paper-toolbar class="header">
        <paper-icon-button icon="menu" class="menu" on-click="_toggle"></paper-icon-button>
        <iron-icon src="resources/youtube.png" class="icon"></iron-icon>
        <div class="search-box">
          <input is="iron-input" bind-value="{{_keywords}}" on-keydown="_check_search">
          <paper-icon-button icon="search" on-click="search"></paper-icon-button>
        </div>
      </paper-toolbar>
    </paper-header-panel>
    <paper-menu id="dropdown-content" class="dropdown-content" role="listbox">
      <paper-button raised class="item">Opcion 1</paper-button>
      <paper-button raised class="item">Opcion 2</paper-button>
      <paper-button raised class="item">Opcion 3</paper-button>
    </paper-menu>
    <!-- MAIN CONTENT -->
    <div class="content">
      <template id="results_template" is="dom-repeat" items="[[_result.items]]">
        <div class="resul-item">
          <img class="thumbnail" src="{{item.snippet.thumbnails.default.url}}">
          <div class="info">
            <div class="result-title">{{item.snippet.title}}</div>
            <div class="result-channel">{{item.snippet.channelTitle}}</div>
            <div class="result-description">{{item.snippet.description}}</div>
          </div>
        </div>
      </template>
    </div>
    <div id="footer" class="footer" hidden="true">
      <paper-icon-button icon="icons:arrow-back" on-click="_before"></paper-icon-button>
      <span>{{_cursor}}</span>
      <paper-icon-button icon="icons:arrow-forward" on-click="_next"></paper-icon-button>
    </div>








    <!-- AJAX CALLS -->
    <iron-ajax
      id="config_request"
      url="{{config_file}}"
      on-response="_config_response"
      >
    </iron-ajax>

    <iron-ajax
      id="language_request"
      url="{{component_base}}language/{{_lan_file}}"
      on-response="_language_response"
      >
    </iron-ajax>

    <iron-ajax
       id="refresh_token" 
       url="https://accounts.google.com/o/oauth2/token" 
       method="POST"
       params="{{_token_params}}" 
       on-response="_token_received"
       >
    </iron-ajax>

    <iron-ajax
       id="search_request" 
       url="{{_base_URL}}/search?{{_search_params}}" 
       on-response="_search_response"
       >
    </iron-ajax>
    
  </template>

  <script>

    Polymer({

      is: 'youtube-wc',

      properties: {

      //PUBLIC CONFIG PARAMS

        config_file: String,

        /* Token: The access_token generated to grant access to the API */
        token: {
          type: String,
          reflectToAttribute: true
        },

        /* Refresh Token: The refresh token generated to update the access_token */
        refresh_token: String,

        /* API Key: The API Key for your application */
        api_key: String,

        /* Client Id: The OAuth 2.0 client ID for your application */
        client_id: String,

        /* Client Secret: The OAuth 2.0 client SECRET for your application */
        client_secret: String,

        /* Component Base: The component base directory */
        component_base: {
          type: String,
          value:""
        },

        /* Language: Language for your application */
        language: {
          type: String,
          value: "en",
          observer: "_languageChanged"
        },

      //INTERNAL CONFIG PARAMS

        /* Token refresh */

        _token_params: {
          type: String,
          computed: "_get_token_params(client_id, client_secret, refresh_token)"
        },

        /* API methods */

        _base_URL: {
          type: String,
          value: "https://www.googleapis.com/youtube/v3"
        },

        _maxResults: {
          type: Number,
          value: 10
        },

        /* Pagination */

        _cursor: {
          type: Number,
          value: 0,
        },

        _cache: {
          type: Object,
          value: [],
        },


      },

      //CONFIG

      _config_response: function(event, detail){

      },

      // LANGUAGE SUPPORT

      _languageChanged: function(newVal, oldValue) {
        switch(newVal){
          case "es":
            this.language = "es";
            this._lan_file = "es_es.json"
            break;
          default:
            this.language = "en";
            this._lan_file = "en_en.json"
        }
        if (this.component_base || this.component_base == "") {
          this.$.language_request.generateRequest();
        }
      },

      _language_response: function(event, detail){
        this.words = detail.response;
      },

      // TOKEN REFRESH

      _get_token_params: function(client_id, client_secret, refresh_token){
        return {
            client_id: client_id, 
            client_secret: client_secret, 
            refresh_token: refresh_token, 
            grant_type: "refresh_token"
          };
      },

      _token_received: function(event, detail){
        this.token = detail.response.access_token;
      },

      // API METHODS

      _search_response: function(event, detail){
        this._result = detail.response;
      },

      // PUBLIC METHODS

      search: function(){
        this._search_params=
        'part=snippet&'+
        'key=' + this.api_key + '&' +
        'q=' + this._keywords + '&' +
        'maxResults=' + this._maxResults;
        
        this._last_search = this._keywords;
        this.$.search_request.generateRequest();
        if(this.$.footer.hidden)this.$.footer.hidden=false;
      },

      _search_next: function(){
        if(this._last_search && this._cache[this._cursor].nextPageToken){
          this._search_params=
          'part=snippet&'+
          'key=' + this.api_key + '&' +
          'q=' + this._last_search + '&' +
          'maxResults=' + this._maxResults + '&' +
          'pageToken=' + this._cache[this._cursor].nextPageToken;
          
          this.$.search_request.generateRequest();
        }
      },

      // ELEMENT BEHAVIOUR

      /* Pagination */

      _clear: function(){
        this._result = null;
        this.$.results_template.render();
      },

      _next: function(){
        if(this._cache[this._cursor+1]){
          this._clear();
          this._result = this._cache[this._cursor+1];
        }
        else{
          //this._cache[this._cursor] = {};
          this._cache[this._cursor] = this._result;
          this._clear();
          this._search_next();
        }        
        this._cursor++;
      },

      _before: function(){
        if(this._cursor > 0){
          if(!this._cache[this._cursor]){
            //this._cache[this._cursor] = {};
            this._cache[this._cursor] = this._result;
          }          
          this._cursor--;
          this._clear();
          this._result = this._cache[this._cursor];
        }        
      },

      /* Side Menu animation */
      _toggle: function(){
        if(this.$['dropdown-content'].style.left=="-105px"){
          this.$['dropdown-content'].style.left="0";
        }
        else{
          this.$['dropdown-content'].style.left="-105px";
        }
      },

      /* Allow search typing ENTER */
      _check_search: function(e){
        if(e.keyCode === 13){
          this.search();
        }
      },

      // Element Lifecycle

      ready: function() {
        // `ready` is called after all elements have been configured, but
        // propagates bottom-up. This element's children are ready, but parents
        // are not.
        //
        // This is the point where you should make modifications to the DOM (when
        // necessary), or kick off any processes the element wants to perform.
      },

      attached: function() {
        // `attached` fires once the element and its parents have been inserted
        // into a document.
        //
        // This is a good place to perform any work related to your element's
        // visual state or active behavior (measuring sizes, beginning animations,
        // loading resources, etc).
        this.$['dropdown-content'].style.left="-105px";
      },

      detached: function() {
        // The analog to `attached`, `detached` fires when the element has been
        // removed from a document.
        //
        // Use this to clean up anything you did in `attached`.
      },

    });


  </script>

</dom-module>